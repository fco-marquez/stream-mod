<!DOCTYPE html>
<html>
<head>
    <title>StreamMod</title>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
    <h1>Stream-MOD</h1>
    <h2>Moderador de chats de Twitch</h2>
    <form method="POST">
        <input type="text" name="twitch_url" placeholder="https://www.twitch.tv/nombre_canal" required />
        <button type="submit">Connect</button>
    </form>

    {% if channel %}
        <div class="stream-container">
            <div class="stream-column">
                <h2>Stream de {{ channel }}</h2>
                <div id="twitch-player"></div>
            </div>
            <div class="chat-column">
                <h2>Chat Moderado</h2>
                <div id="chat-box" class="chat-box"></div>
            </div>
        </div>
        <div class="moderation-container">
            <div class="moderation-panel">
                <h3>Razones de Moderación</h3>
                <div class="reason-filters">
                    <label><input type="checkbox" name="reason" value="appropriate" checked><span>Apropiado</span></label>
                    <label><input type="checkbox" name="reason" value="hate_speech" checked><span>Discurso de Odio</span></label>
                    <label><input type="checkbox" name="reason" value="harassment" checked><span>Acoso</span></label>
                    <label><input type="checkbox" name="reason" value="inappropriate" checked><span>Contenido Inapropiado</span></label>
                    <label><input type="checkbox" name="reason" value="spam" checked><span>Spam</span></label>
                    <label><input type="checkbox" name="reason" value="categoria_5" checked><span>Categoría 5</span></label>
                    <label><input type="checkbox" name="reason" value="categoria_6" checked><span>Categoría 6</span></label>
                    <label><input type="checkbox" name="reason" value="categoria_7" checked><span>Categoría 7</span></label>
                    <label><input type="checkbox" name="reason" value="categoria_8" checked><span>Categoría 8</span></label>
                    <label><input type="checkbox" name="reason" value="categoria_9" checked><span>Categoría 9</span></label>
                    <label><input type="checkbox" name="reason" value="categoria_10" checked><span>Categoría 10</span></label>
                </div>
            </div>
        </div>
        <!-- Modal -->
        <div id="message-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3>Mensaje Moderado</h3>
                <p><strong>usuario:</strong> <span id="modal-user"></span></p>
                <p><strong>Enviado a las:</strong> <span id="modal-time"></span></p>
                <p><strong>Mensaje:</strong></p>
                <p id="modal-message"></p>
                <p><strong>Razón:</strong> <span id="modal-reason"></span></p>
            </div>
        </div>
    {% endif %}

    {% if channel %}
    <script>
        // Initialize Twitch player with secure options
        var options = {
            channel: "{{ channel }}",
            width: "100%",
            height: 500,
            layout: "video",
            autoplay: true,
            parent: window.location.hostname
        };
        
        // Create player only if we're on a secure context or localhost
        if (window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            new Twitch.Player("twitch-player", options);
        } else {
            document.getElementById("twitch-player").innerHTML = 
                '<div class="twitch-error">El reproductor de Twitch requiere una conexión segura (HTTPS) o localhost</div>';
        }

        // Initialize moderation reasons with all categories
        window.selectedReasons = new Set([
            'appropriate', 'hate_speech', 'harassment', 'inappropriate', 'spam',
            'categoria_5', 'categoria_6', 'categoria_7', 'categoria_8', 'categoria_9', 'categoria_10'
        ]);
        
        document.querySelectorAll('.reason-filters input').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                window.updateSelectedReasons(e.target.value, e.target.checked);
            });
        });
    </script>
    <script lang="javascript" src="{{ url_for('static', filename='js/chat.js') }}"></script>
    {% endif %}
</body>
</html>
